# Analysis pipeline for Hodgkins Lymphoma study

This pipeline takes as input CSV files and TIFF images generated by Halo, in addition to a specific set of user-curated study meta data files to compare sample groups. Each comparison involves extensive metrics, statistics and visualizations.

#### NOTE: this document is meant as a general guide. Specific instructions for running on juno can be found in
```
    /home/byrne/halo/dev/hodgkins_dev/HOW_TO_RUN_PIPELINE.txt
```


## Prerequisites & system setup

See setup [instructions](docs/setup.md)


## Curate input data

#### Meta data files to be created are:

    - [StudyName]_CellStates__V[version_number].xlsx
    - [StudyName]_CellTypes__V[version_number].xlsx
    - [StudyName]_FOVs__V[version_number].xlsx
    - [StudyName]_Markers__V[version_number].xlsx
    - [StudyName]_Paths__V[version_number].xlsx
    - [StudyName]_Questions__V[version_number].xlsx
    - [StudyName]_Samples__V[version_number].xlsx
    - [StudyName]_StudyOverview__V[version_number].xlsx

See [study_meta_data.md](docs/study_meta_data.md) for instructions on how to create each of these files.

## Configuration
Run configuration script to create project directory structure and generate YAML file of configuration to be used throughout the pipeline. Source files specified will be linked locally. 

#### IMPORTANT: these instructions are written under the assumption the following files have previously been created: 
```
1) drift summary files
2) Halo RDA files with exclusions marked
3) Neighbor RDA files with cell-to-cell distances
```

Create project directory and run configuration
```
mkdir [project_dir]
cd [project_dir]
Rscript [src_dir]/scripts/configure_study.R \
  --study_name [StudyName] \
  --source_meta_dir [path_to_meta_XLSX_files] \
  --source_halo_data_dir [path_to_halo_RDA_files] \
  --source_halo_csv_dir [path_to_halo_CSV_files] \
  --source_halo_coord_dir [path_to_halo_coordinate_XML_files] \
  --source_drift_summary_dir [path_to_drift_summary_TXT_files] \
  --source_neighbor_dir [path_to_cell_neighbor_RDA_files]
```

In addition to creating the directory structure for your study, the configuration will link all source files to the newly created project directory and set the configuration to point to the local directories. Study configuration will be validated and written to:

    **input/config/study_config.yaml**

**NOTE: One of the most important checks done during configuration is the list of samples to be analyzed. PLEASE review warnings carefully & fix errors before proceeding!!**

## Input data validation

It is a good idea to check all manually-created meta files for errors. This is not required as it is the first step of the pipeline anyway, but doing so first can help save you a log of debugging headaches later on. You may either pass to the script the entire configuration or just the directory of meta data files.

```
Rscript [src_dir]/scripts/validate_input.R \
    --manifest input/config/study_config.yaml
```
or if configuration is not yet set up/validated:
```
Rscript [src_dir]/scripts/validate_input.R \
    --meta_dir /path/to/meta/files \
    --statistics_questions_file  /path/to/stats/questions/xlsx/file
```

## Run pipeline

A convenience shell script was created to easily launch pipeline on a LSF cluster.
NOTE: this will need to be customized to your system.
```
sh [src_dir]/pipeline/run.sh
```

